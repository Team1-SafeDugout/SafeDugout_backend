<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="adminTrade">

	<!-- 거래중인 목록 조회 -->
	<select id="listSelect" parameterType="map"
		resultType="TradePostDTO">
	<![CDATA[
	SELECT *
	FROM (
	    SELECT ROWNUM AS rnum, subquery.*
	    FROM (
	        SELECT SP.SELL_POST_NUMBER,
	               SP.SELL_POST_TITLE,
	               SP.SELL_POST_CONTENT,
	               SP.PRICE_POINT,
	               SP.TRADING_AREA,
	               SP.SELL_POST_CREATION_DATE,
	               M.MEMBER_ID AS Buyer_ID,
	               TS.STATUS_NAME
	        FROM TBL_SELL_POST SP
	        JOIN TBL_MEMBER M ON SP.MEMBER_NUMBER = M.MEMBER_NUMBER
	        JOIN TBL_TRADE_POST TP ON SP.SELL_POST_NUMBER = TP.SELL_POST_NUMBER
	        JOIN TBL_TRADE_STATUS TS ON TP.STATUS_NUMBER = TS.STATUS_ID
	        WHERE TS.STATUS_ID = 'SOLD'
	        ORDER BY SP.SELL_POST_CREATION_DATE DESC
	    ) subquery
	)
	WHERE rnum BETWEEN #{startRow} AND #{endRow}
	]]>
	</select>

	<select id="total" resultType="int">
		SELECT COUNT(TRADE_POST_NUMBER)
		FROM TBL_TRADE_POST
	</select>

	<!-- 전체 -->
	<select id="selectAll" resultType="TradePostDTO">
	<![CDATA[
	SELECT
		TRADE_NUMBER,
		SELL_POST_NUMBER,
		STATUS_NUMBER,
		BUY_MEMBER,
		PAYMENT_DATE,
		COMPLETE_DATE
	FROM TBL_TRADE_POST JOIN 
	]]>
	</select>

	<select id="selectAllInfo" resultType="AdminTradeListDTO">
	<![CDATA[
	SELECT * FROM (
    SELECT ROWNUM AS rnum, subquery.*
    	FROM (
			SELECT 
					ttp.TRADE_NUMBER ,
					tsp.SELL_POST_TITLE,
					tsp.SELL_POST_CONTENT, 
					tsp.SELL_POST_UPDATE,
					SELLER.MEMBER_ID seller,
					BUYER.MEMBER_ID buyer,
					tc.CATEGORY_NAME,
					COALESCE(tt.TEAM_NAME, '전체') AS TEAMNAME,
					td.DEALTYPE_NAME,
					COALESCE(ta.ATTACHMENT_PATH, 'none') as attachmentPath,
					tts.STATUS_NAME,
					tsp.PRICE_POINT
			FROM TBL_TRADE_POST ttp
			JOIN TBL_SELL_POST tsp ON ttp.SELL_POST_NUMBER = tsp.SELL_POST_NUMBER 
			JOIN TBL_CATEGORY tc ON tsp.CATEGORY_ID = tc.CATEGORY_ID 
			LEFT JOIN TBL_TEAM tt ON tsp.TEAM_ID = tt.TEAM_NUMBER
			JOIN TBL_TRADE_STATUS tts ON ttp.STATUS_NUMBER = tts.STATUS_ID
			JOIN TBL_MEMBER SELLER ON tsp.MEMBER_NUMBER = SELLER.MEMBER_NUMBER
			JOIN TBL_MEMBER BUYER ON ttp.BUY_MEMBER = BUYER.MEMBER_NUMBER
			JOIN TBL_DEALTYPE td ON tsp.DEALTYPE_ID = td.DEALTYPE_ID
			LEFT JOIN TBL_ATTACHMENT ta ON tsp.SELL_POST_NUMBER = ta.SELL_POST_NUMBER
    	    ORDER BY ttp.TRADE_NUMBER DESC
    	) subquery
	)
	WHERE rnum BETWEEN #{startRow} AND #{endRow}
	]]>
	</select>
	
	<select id = "selectSellPostDetail" parameterType="int" resultType="AdminTradeListDTO">
	<![CDATA[
	SELECT 
			ttp.TRADE_NUMBER ,
			tsp.SELL_POST_TITLE,
			tsp.SELL_POST_CONTENT, 
			tsp.SELL_POST_UPDATE,
			SELLER.MEMBER_ID seller,
			BUYER.MEMBER_ID buyer,
			tc.CATEGORY_NAME,
			COALESCE(tt.TEAM_NAME, '전체') AS TEAMNAME,
			td.DEALTYPE_NAME,
			COALESCE(ta.ATTACHMENT_PATH, 'none') as attachmentPath,
			tts.STATUS_NAME,
			tsp.PRICE_POINT
	FROM TBL_TRADE_POST ttp
	JOIN TBL_SELL_POST tsp ON ttp.SELL_POST_NUMBER = tsp.SELL_POST_NUMBER 
	JOIN TBL_CATEGORY tc ON tsp.CATEGORY_ID = tc.CATEGORY_ID 
	LEFT JOIN TBL_TEAM tt ON tsp.TEAM_ID = tt.TEAM_NUMBER
	JOIN TBL_TRADE_STATUS tts ON ttp.STATUS_NUMBER = tts.STATUS_ID
	JOIN TBL_MEMBER SELLER ON tsp.MEMBER_NUMBER = SELLER.MEMBER_NUMBER
	JOIN TBL_MEMBER BUYER ON ttp.BUY_MEMBER = BUYER.MEMBER_NUMBER
	JOIN TBL_DEALTYPE td ON tsp.DEALTYPE_ID = td.DEALTYPE_ID
	LEFT JOIN TBL_ATTACHMENT ta ON tsp.SELL_POST_NUMBER = ta.SELL_POST_NUMBER
	WHERE TRADE_NUMBER = #{postNumber}
	]]>
	</select>

</mapper>