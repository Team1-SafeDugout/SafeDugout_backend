<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="TeamCommunityMapper">

	<!-- 팀 게시글 목록 조회 -->
	<select id="select" resultType="TeamPostDTO">
		<![CDATA[
		SELECT P.POST_NUMBER, P.POST_TITLE, P.POST_CONTENT,	P.POST_DATE, M.MEMBER_NAME AS POST_WRITER
		FROM TBL_POST P
		JOIN TBL_MEMBER M ON P.MEMBER_NUMBER = M.MEMBER_NUMBER
		WHERE P.BOARD_ID = 2
		AND P.TEAM_NUMBER = {teamNumber}
		ORDER BY P.POST_DATE DESC
		]]>
	</select>

	<!-- 게시글 작성 -->
	<insert id="insert" parameterType="PostDTO">
		<selectKey keyProperty="SellPostNumber" resultType="int" order="BEFORE">
			SELECT SEQ_SELL_POST.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO TBL_POST (POST_NUMBER, MEMBER_NUMBER, TEAM_NUMBER, BOARD_ID, POST_TITLE, POST_CONTENT, POST_DATE)
    	 VALUES (#{postNumber}, #{memberNumber}, #{teamNumber}, 2, #{postTitle}, #{postContent}, sysdate);
	</insert>

	<!-- 팀 게시글 상세 조회 -->
	<select id="detailSelect" parameterType="PostDetailDTO">
		<![CDATA[
		SELECT P.POST_NUMBER,
	    P.POST_TITLE,
	    P.POST_CONTENT,
	    P.POST_DATE,
	    M.MEMBER_ID AS POST_WRITER,
	    C.COMMENT_NUMBER,
	    C.COMMENT_CONTENT,
	    NVL(C.COMMENT_UPDATE, C.COMMENT_DATE) AS COMMENT_LAST_UPDATE,
	    CM.MEMBER_ID AS COMMENT_WRITER,
	    A.ATTACHMENT_NUMBER,
	    A.ATTACHMENT_NAME,
	    A.ATTACHMENT_PATH
	  	FROM TBL_POST P
		JOIN TBL_MEMBER M ON P.MEMBER_NUMBER = M.MEMBER_NUMBER                
		LEFT JOIN TBL_COMMENT C ON P.POST_NUMBER = C.POST_NUMBER              
		LEFT JOIN TBL_MEMBER CM ON C.MEMBER_NUMBER = CM.MEMBER_NUMBER         
		LEFT JOIN TBL_POST_ATTACHMENT PA ON P.POST_NUMBER = PA.POST_NUMBER    
		LEFT JOIN TBL_ATTACHMENT A ON PA.ATTACHMENT_NUMBER = A.ATTACHMENT_NUMBER
		WHERE P.POST_NUMBER = #{postNumber}                                  
	  	AND P.TEAM_NUMBER = #{teamNumber}                                 
		ORDER BY C.COMMENT_DATE ASC, A.ATTACHMENT_NUMBER ASC
		]]>
	</select>

	<!-- 팀 뉴스글 상세 조회 -->
	<select id="detailNewsSelect" parameterType="NewsDetailDTO">
		<![CDATA[
		SELECT P.POST_NUMBER,
	    P.POST_TITLE,
	    P.POST_CONTENT,
	    P.POST_DATE,
	    p.JOURNALIST,
	    A.ATTACHMENT_NUMBER,
	    A.ATTACHMENT_NAME,
	    A.ATTACHMENT_PATH
	  	FROM TBL_POST P                                
		LEFT JOIN TBL_POST_ATTACHMENT PA ON P.POST_NUMBER = PA.POST_NUMBER    
		LEFT JOIN TBL_ATTACHMENT A ON PA.ATTACHMENT_NUMBER = A.ATTACHMENT_NUMBER
		WHERE P.POST_NUMBER = #{postNumber}                                  
	  	AND P.TEAM_NUMBER = #{teamNumber}                                 
		ORDER BY A.ATTACHMENT_NUMBER ASC
		]]>
	</select>
	
	<!-- 게시글 삭제 -->
	<delete id="delete" parameterType="int">
		delete from tbl_post
		where
		post_number = #{postNumber}
		AND TEAM_NUMBER =#{teamNumber}
	</delete>



	<!-- 게시글 수정쿼리 -->
	<update id="update" parameterType="TeamPostDTO">
		UPDATE tbl_post SET
		post_title = #{postTitle}, post_content = #{postContent},
		post_update = #{postUpdate}
		where post_number = #{postNumber}
	</update>


	<!-- 팀 유튜브 목록 조회 -->
	<select id="youtubeSelect" resultType="YoutubePostDTO">
		<![CDATA[
		SELECT * FROM (
        SELECT ROWNUM AS rnum, subquery.*
        FROM (
            SELECT p.POST_NUMBER,
                   p.POST_TITLE,
                   p.POST_DATE,
                   p.POST_CONTENT,
                   p.POST_LINK,
                   t.TEAM_NAME,
                   t.TEAM_NUMBER,
                   a.ADMIN_id
            FROM TBL_POST p
            JOIN TBL_TEAM t ON p.TEAM_NUMBER = t.TEAM_NUMBER
            JOIN TBL_ADMIN a ON p.ADMIN_NUMBER = a.ADMIN_NUMBER
            WHERE p.BOARD_ID = 4
            AND p.TEAM_NUMBER = #{teamNumber}
            ORDER BY p.POST_DATE DESC
        ) subquery
    )WHERE rnum BETWEEN #{startRow} AND #{endRow}
		]]>
	</select>



	<!-- 팀/선수 응원가 목록 조회 -->
	<select id="songSelect" resultType="SongPostDTO">
		<![CDATA[
		SELECT * FROM (
	        SELECT ROWNUM AS rnum, subquery.*
	        FROM (
	            SELECT POST_NUMBER,
	                   POST_TITLE,
	                   POST_DATE,
	                   TEAM_NUMBER,
	                   BOARD_TYPE_ID,
	                   POST_LINK,
	                   ADMIN_ID,
	                   POST_CONTENT
	            FROM TBL_POST
	            WHERE BOARD_TYPE_ID IN (5, 6)
	              AND TEAM_NUMBER = #{teamNumber}
	            ORDER BY POST_DATE DESC
	        )subquery
	    )
	    WHERE rnum BETWEEN #{startRow} AND #{endRow};
		]]>
	</select>
	
	<!-- 팀응원가 목록 조회 -->
	<select id="TeamSongSelect" resultType="SongPostDTO">
		<![CDATA[
		SELECT * FROM (
	        SELECT ROWNUM AS rnum, subquery.*
	        FROM (
	            SELECT POST_NUMBER,
	                   POST_TITLE,
	                   POST_DATE,
	                   TEAM_NUMBER,
	                   BOARD_TYPE_ID,
	                   POST_LINK,
	                   ADMIN_ID,
	                   POST_CONTENT
	            FROM TBL_POST
	            WHERE BOARD_TYPE_ID = 5
	              AND TEAM_NUMBER = #{teamNumber}
	            ORDER BY POST_DATE DESC
	        )subquery
	    )
	    WHERE rnum BETWEEN #{startRow} AND #{endRow};
		]]>
	</select>
	
	<!-- 선수 응원가 목록 조회 -->
	<select id="playerSongSelect" resultType="SongPostDTO">
		<![CDATA[
		SELECT * FROM (
	        SELECT ROWNUM AS rnum, subquery.*
	        FROM (
	            SELECT POST_NUMBER,
	                   POST_TITLE,
	                   POST_DATE,
	                   TEAM_NUMBER,
	                   BOARD_TYPE_ID,
	                   POST_LINK,
	                   ADMIN_ID,
	                   POST_CONTENT
	            FROM TBL_POST
	            WHERE BOARD_TYPE_ID = 6
	              AND TEAM_NUMBER = #{teamNumber}
	            ORDER BY POST_DATE DESC
	        )subquery
	    )
	    WHERE rnum BETWEEN #{startRow} AND #{endRow};
		]]>
	</select>
		
	<!-- 팀뉴스 목록 조회 -->
	<select id="newsSelect" resultType="NewsPostDTO">
		<![CDATA[
		  SELECT * FROM (
	        SELECT ROWNUM AS rnum, subquery.*
	        FROM (
	            SELECT POST_NUMBER,
	                   POST_TITLE,
	                   POST_CONTENT,
	                   POST_DATE,
	                   TEAM_NUMBER,
	                   JOURNALIST
	            FROM TBL_POST
	            WHERE BOARD_ID = 3
	            AND TEAM_NUMBER = #{teamNumber}
	            ORDER BY POST_DATE DESC
	        ) subquery
	    )WHERE rnum BETWEEN #{startRow} AND #{endRow};
		]]>
	</select>


	<!-- 팀 시즌 기록 목록 조회 -->
	<select id="teamRecordSelect" parameterType="int" resultType="TeamRecordDTO">
		<![CDATA[
		SELECT TR.SEASON_YEAR, T.TEAM_NAME,	TR.TEAM_RANK, TR.GAME_COUNT, TR.TEAM_WIN, TR.TEAM_DRAW, TR.TEAM_LOSE, TR.TEAM_WIN_RATE, TR.TEAM_AVG_BAT, TR.TEAM_ERA,
       	TR.TEAM_SCORE, TR.TEAM_CONCEDE
		FROM TBL_TEAM_RECORD TR
		JOIN TBL_TEAM T ON TR.TEAM_NUMBER = T.TEAM_NUMBER
		WHERE TR.TEAM_NUMBER = #{teamNumber}
		ORDER BY TR.SEASON_YEAR DESC
		]]>
	</select>

	<!-- 팀 투수 시즌 기록 조회 -->
	<select id="pitcherRecordSelect" parameterType="int" resultType="TeamPitcherRecordDTO">
		<![CDATA[
		SELECT TPR.SEASON_YEAR,
       	T.TEAM_NAME, TPR.TEAM_PITCHER_ERA, TPR.TEAM_PITCHER_START_ERA, TPR.TEAM_PITCHER_RELIEF_ERA, TPR.TEAM_PITCHER_GAME_COUNT, TPR.TEAM_PITCHER_WIN,
       	TPR.TEAM_PITCHER_LOSE, TPR.TEAM_PITCHER_SAVE, TPR.TEAM_PITCHER_HOLD, TPR.TEAM_PITCHER_STRIKEOUT, TPR.TEAM_PITCHER_HITS,
       	TPR.TEAM_PITCHER_HR, TPR.TEAM_PITCHER_BB, TPR.TEAM_PITCHER_HBP, TPR.TEAM_PITCHER_SCORE, TPR.TEAM_PITCHER_SELF_SCORE
		FROM TBL_TEAM_PITCHER_RECORD TPR
		JOIN TBL_TEAM T ON TPR.TEAM_NUMBER = T.TEAM_NUMBER
		WHERE TPR.TEAM_NUMBER = 2
		ORDER BY TPR.SEASON_YEAR DESC
		]]>
	</select>

	<!-- 팀 타자 시즌 기록 조회 -->
	<select id="batterRecordSelect" parameterType="int" resultType="TeamBatterRecordDTO">
		<![CDATA[
		SELECT TBR.SEASON_YEAR,
        T.TEAM_NAME, TBR.TEAM_BATTER_AVG_BAT, TBR.TEAM_BATTER_GAME_COUNT, TBR.TEAM_BATTER_AT_BAT,
        TBR.TEAM_BATTER_RBI, TBR.TEAM_BATTER_SCORE, TBR.TEAM_BATTER_HITS, TBR.TEAM_BATTER_DOUBLE_HIT,
        TBR.TEAM_BATTER_TRIPLE_HIT, TBR.TEAM_BATTER_HR, TBR.TEAM_BATTER_BB, TBR.TEAM_BATTER_GIDOUT,
        TBR.TEAM_BATTER_HBP, TBR.TEAM_BATTER_STRIKEOUT, TBR.TEAM_BATTER_OPS, TBR.TEAM_BATTER_STOLEN_BASE
		FROM TBL_TEAM_BATTER_RECORD TBR
		JOIN TBL_TEAM T ON TBR.TEAM_ID = T.TEAM_NUMBER
		WHERE TBR.TEAM_ID = #{teamId}
		ORDER BY TBR.SEASON_YEAR DESC
		]]>
	</select>
	
	<!-- 팀 수비/주루기록 -->
	<select id="deffenseBaseRecord" parameterType="int" resultType="DeffenseBaseRecordDTO">
	SELECT 
    T.TEAM_NAME,
    R.SEASON_YEAR,
    R.GAME_COUNT,
    R.ERROR,
    R.GIDOUT,
    R.SB_ALLOW,
    R.SB_BLOCK,
    R.SB_SUCCESS,
    R.PICK_OFF,
    R.PICK_OFF_SUCCESS	
	FROM TBL_DEFENSE_BASE_RECORD R
	JOIN TBL_TEAM T ON R.TEAM_NUMBER = T.TEAM_NUMBER
	WHERE R.TEAM_NUMBER = #{teamNumber}
	AND R.SEASON_YEAR = #{seasonYear}
	ORDER BY R.SEASON_YEAR DESC;
	</select>
	
	<!-- 선수 타자 기록 -->
	<select id="playerBatterRecord" parameterType="int" resultType="BatterRecordDTO">
	SELECT 
	    T.TEAM_NAME,
	    P.PLAYER_NAME,
	    P.PLAYER_POSITION,
	    P.TEAM_NUMBER,
	    TO_CHAR(B.BATTER_SEASON_YEAR, 'YYYY') AS SEASON_YEAR,
	    B.BATTER_GAMES,
	    B.AB,
	    B.PA,
	    B.RBI,
	    B.HITS,
	    B.DOUBLE_HIT,
	    B.TRIPLE_HIT,
	    B.HOME_RUN,
	    B.BATTER_BB,
	    B.IBB,
	    B.BATTER_HBP,
	    B.SO,
	    B.GDP,
	    B.SRBI,
	    B.OPS,
	    B.SB
	FROM TBL_BATTER_RECORD B
	JOIN TBL_PLAYER P ON B.PLAYER_NUMBER = P.PLAYER_NUMBER
	JOIN TBL_TEAM T ON P.TEAM_NUMBER = T.TEAM_NUMBER
	WHERE P.TEAM_NUMBER = #{teamNumber}
	ORDER BY B.BATTER_SEASON_YEAR DESC, P.PLAYER_NUMBER;
	</select>
	
	<!-- 투수 기록 -->
	<select id="playerPitcherRecord" parameterType="int" resultType="PitcherRecordDTO">
	SELECT 
	    T.TEAM_NAME,
	    P.PLAYER_NAME,
	    P.PLAYER_POSITION,
	    P.TEAM_NUMBER,
	    TO_CHAR(R.PITCHER_SEASON_YEAR, 'YYYY') AS SEASON_YEAR,
	    R.PITCHER_GAMES,
	    R.CG,
	    R.SHO,
	    R.GS,
	    R.WINS,
	    R.LOSSES,
	    R.SAVES,
	    R.HOLD,
	    R.IP,
	    R.RA,
	    R.ER,
	    R.ERA,
	    R.HIT_ALLOWED,
	    R.HR_ALLOWED,
	    R.PITCHER_BB,
	    R.PITCHER_HBP,
	    R.BK
	FROM TBL_PITCHER_RECORD R
	JOIN TBL_PLAYER P ON R.PLAYER_NUMBER = P.PLAYER_NUMBER
	JOIN TBL_TEAM T ON P.TEAM_NUMBER = T.TEAM_NUMBER
	WHERE P.TEAM_NUMBER = #{teamNumber}
	ORDER BY R.PITCHER_SEASON_YEAR DESC, P.PLAYER_NUMBER
	</select>
	
	<!-- 게시판 총 갯수 -->
	<select id="getTotalBoard" resultType="int">
		SELECT COUNT(post_number)
		FROM tbl_post
		where board_id = 2
	</select>
	<!-- 뉴스 총 갯수  -->
	<select id="getTotalNews" resultType="int">
		SELECT COUNT(post_number)
		FROM tbl_post
		where board_id = 3
	</select>
	
	<!-- 유튜브 총 갯수 -->
	<select id="getTotalYoutube" resultType="int">
		SELECT COUNT(post_number)
		FROM tbl_post
		where board_id = 4
	</select>
		
	<!-- 팀응원가 총 갯수 -->
	<select id="getTotalSong" resultType="int">
		SELECT COUNT(post_number)
		FROM tbl_post
		where board_id IN(5, 6)
	</select>	
	
	<!-- 팀응원가 총 갯수 -->
	<select id="getTotalTeamSong" resultType="int">
		SELECT COUNT(post_number)
		FROM tbl_post
		where board_id = 5
	</select>	
	
	<!-- 선수 응원가 총 갯수 -->
	<select id="getTotalPlayerSong" resultType="int">
		SELECT COUNT(post_number)
		FROM tbl_post
		where board_id = 6
	</select>
	
	<!-- 경기장 정보 조회 -->
	<select id="selectStadium" parameterType="int" resultType="StadiumDTO">
	SELECT 
	    STADIUM_NUMBER,
	    STADIUM_NAME,
	    STADIUM_ADDRESS,
	    TEAM_NUMBER
	FROM TBL_STADIUM
	WHERE TEAM_NUMBER = #{teamNumber};
	</select>
	
	<!-- 경기장 티켓 조회 -->
	<select id="selectTictek" parameterType="int" resultType="StadiumTictekDTO">
		SELECT 
	    TICKET_ID,
	    STADIUM_NUMBER,
	    TEAM_NUMBER,
	    SEAT_NAME,
	    WEEKDAY_PRICE,
	    WEEKEND_PRICE,
	    RESERVATION_SITE
	FROM TBL_STADIUM_TICKET
	WHERE TEAM_NUMBER = #{stadiumNumber};
	</select>
	
	<!-- 경기장 먹거리 조회 -->
	<select id="selectFood" parameterType="int" resultType="StadiumFoodDTO">
	SELECT 
	    FOOD_ID,
	    FOOD_NAME,
	    FOOD_LOCATION,
	    FOOD_TIP,
	    STADIUM_NUMBER
	FROM TBL_STADIUM_FOOD
	WHERE TEAM_NUMBER = #{stadiumNumber};
	</select>
	
	<!-- 게임 일정 조회 -->
	<select id="selectGame" parameterType="int" resultType="GameSchduleDTO">
	SELECT
	    gs.GAME_ID,
	    gs.SCHEDULE_DATE,
	    ht.TEAM_NAME AS HOME_TEAM,
	    at.TEAM_NAME AS AWAY_TEAM,
	    s.STADIUM_NAME,
	    s.STADIUM_ADDRESS
	FROM
	    TBL_GAME_SCHEDULE gs
	JOIN TBL_TEAM ht
	    ON gs.HOME_TEAM_NUMBER = ht.TEAM_NUMBER
	JOIN TBL_TEAM at
	    ON gs.AWAY_TEAM_NUMBER = at.TEAM_NUMBER
	JOIN TBL_STADIUM s
	    ON gs.STADIUM_NUMBER = s.STADIUM_NUMBER
	WHERE
	    gs.HOME_TEAM_NUMBER = #{teamNumber} OR gs.AWAY_TEAM_NUMBER = #{teamNumber}
	ORDER BY
	    gs.SCHEDULE_DATE;	
	</select>
	
</mapper>