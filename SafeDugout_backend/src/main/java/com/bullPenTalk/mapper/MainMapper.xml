<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="main">

	<!-- 로그인한 회원 정보 가져오기 -->
	<select id="selectLoginMember" parameterType="int" resultType="MemberDTO">
		SELECT * FROM TBL_MEMBER 
		WHERE MEMBER_NUMBER = #{memberNumber}
	</select>
	
	<!-- 메인 공지사항 목록 조회 -->
	<select id="selectMainList" resultType="MainNoticePostDTO">
	<![CDATA[
	SELECT *
	FROM (
	    SELECT ROWNUM AS rnum, subquery.*
	    FROM (
	        SELECT NOTICE_POST_NUMBER,
	               NOTICE_POST_TITLE,
	               TO_CHAR(NOTICE_POST_DATE, 'YYYY-MM-DD') AS NOTICE_POST_DATE
	        FROM TBL_NOTICE_POST 
	        WHERE NOTICE_TYPE_ID = 1
	        ORDER BY NOTICE_POST_DATE DESC
	    ) subquery
	)
	WHERE rnum BETWEEN #{startRow} AND #{endRow}
	]]>
	</select>
	
	<!-- 메인 공지사항 최신 항목(제목) 가져오기 -->
	<select id="getRecent" resultType="MainNoticePostDTO">
		SELECT * FROM 
		(SELECT NOTICE_POST_TITLE
		FROM TBL_NOTICE_POST
		WHERE NOTICE_TYPE_ID = 1
		ORDER BY NOTICE_POST_DATE DESC)
		WHERE ROWNUM = 1
	</select>
	
	<!-- 입문 가이드 최신 항목(제목) 가져오기 -->
	<select id="getRecentGuide" resultType="GuidePostDTO">
		SELECT * FROM 
		(SELECT NOTICE_POST_TITLE
		FROM TBL_NOTICE_POST
		WHERE NOTICE_TYPE_ID = 3
		ORDER BY NOTICE_POST_DATE DESC)
		WHERE ROWNUM = 1
	</select>
	
	<!-- 공지사항 총 개수 가져오기 -->
	<select id="getTotalMainList" resultType="int">
		SELECT COUNT(NOTICE_POST_NUMBER)
		FROM TBL_NOTICE_POST	
		WHERE NOTICE_TYPE_ID = 1
	</select>
	
	<!-- 메인 공지사항 상세 조회 -->
	<select id="selectMainDetail" parameterType="int" resultType="MainNoticePostDTO">
		SELECT NOTICE_POST_NUMBER, 
				NOTICE_POST_TITLE, 
				TO_CHAR(NOTICE_POST_DATE, 'YYYY-MM-DD HH:mi') AS NOTICE_POST_DATE, 
				TO_CHAR(NOTICE_POST_UPDATE, 'YYYY-MM-DD HH:mi') AS NOTICE_POST_UPDATE, 
				NOTICE_POST_CONTENT
		FROM TBL_NOTICE_POST
		where notice_type_id = 1 and notice_post_number = #{noticePostNumber}
	</select>
	
	<!-- 메인 공지사항 상세 조회 (이전글) -->
	<select id="selectMainPrev" parameterType="int" resultType="MainNoticePostDTO">
	<![CDATA[
	SELECT notice_post_number, 
			notice_post_title, 
			notice_post_date, 
			notice_post_update,
			notice_post_content
	FROM (SELECT rownum rn2, n.* FROM tbl_notice_post n)
	WHERE rn2 = (SELECT rn - 1 FROM (
		SELECT rownum rn, n2.notice_post_number
		FROM tbl_notice_post n2
		WHERE n2.notice_type_id = 1
		order by n2.notice_post_number desc) subquery
		WHERE subquery.notice_post_number = #{noticePostNumber}
	)
	]]>
	</select>
	
	<!-- 메인 공지사항 상세 조회 (다음글) -->
	<select id="selectMainNext" parameterType="int" resultType="MainNoticePostDTO">
	<![CDATA[
	SELECT notice_post_number, 
			notice_post_title, 
			notice_post_date, 
			notice_post_update,
			notice_post_content
	FROM (SELECT rownum rn2, n.* FROM tbl_notice_post n)
	WHERE rn2 = (SELECT rn + 1 FROM (
		SELECT rownum rn, n2.notice_post_number
		FROM tbl_notice_post n2
		WHERE n2.notice_type_id = 1
		order by n2.notice_post_number desc) subquery
		WHERE subquery.notice_post_number = #{noticePostNumber}
	)
	]]>
	</select>
	
	<!-- 현재 메인 공지사항 항목 순서 가져오기 -->
	<select id="getMainIndex" parameterType="int" resultType="int">
	<![CDATA[
		SELECT rn FROM (
			SELECT rownum rn, n2.notice_post_number
			FROM tbl_notice_post n2
			WHERE n2.notice_type_id = 1
			order by n2.notice_post_number desc) subquery
		WHERE subquery.notice_post_number = #{noticePostNumber}
	]]>
	</select>
	
	<!-- 경기 일정 목록 조회(조회일자로부터 가장 가까운 일자의 경기) -->
	<select id="selectSchedule" resultType="MainDTO">
	<![CDATA[
	SELECT T1.TEAM_NAME AS AWAY_TEAM_NAME , ST.STADIUM_NAME, T2.TEAM_NAME AS HOME_TEAM_NAME, TO_CHAR(SC.SCHEDULE_DATE, 'FMMM.FMDD(DY) HH:MI') AS SCHEDULE_DATE
	FROM TBL_GAME_SCHEDULE SC JOIN TBL_STADIUM ST ON SC.HOME_TEAM_NUMBER = ST.TEAM_NUMBER
	JOIN TBL_TEAM T1 ON SC.HOME_TEAM_NUMBER = T1.TEAM_NUMBER
	JOIN TBL_TEAM T2 ON SC.AWAY_TEAM_NUMBER = T2.TEAM_NUMBER
	WHERE TRUNC(SC.SCHEDULE_DATE) - TRUNC(SYSDATE) = (
		SELECT MIN(TRUNC(SCHEDULE_DATE) - TRUNC(SYSDATE))
		FROM TBL_GAME_SCHEDULE
		WHERE (SCHEDULE_DATE - SYSDATE) >= 0
	)
	]]>
	</select>
	
	<!-- 판매글 목록 조회 -->
	<select id="selectSellList" resultType="MainDTO">
	<![CDATA[
	SELECT *
	FROM (
	    SELECT ROWNUM AS rnum, subquery.*
	    FROM (
	        SELECT S.SELL_POST_NUMBER, 
	        		S.SELL_POST_TITLE, 
	        		TO_CHAR(S.SELL_POST_CREATION_DATE, 'YYYY.MM.DD.') AS SELL_POST_CREATION_DATE, 
	        		S.PRICE_POINT, 
	        		A.ATTACHMENT_PATH
	        FROM TBL_SELL_POST S
	        LEFT OUTER JOIN TBL_ATTACHMENT A 
	        ON S.SELL_POST_NUMBER = A.SELL_POST_NUMBER
	        ORDER BY SELL_POST_CREATION_DATE DESC
	    ) subquery
	)
	WHERE rnum <= 3
	]]>
	</select>
	
	<!-- 팀 순위 목록 조회 -->
	<select id="selectTeamRank" resultType="MainDTO">
	<![CDATA[
		select r.team_rank, t.team_name, r.game_count, r.team_win, r.team_draw, r.team_lose, r.team_win_rate, r.team_gb
		from tbl_team_ranking r join tbl_team t on r.team_number = t.team_number
		order by r.team_rank
	]]>
	</select>
	
	<!-- 입문자 가이드 목록 조회 -->
	<select id="selectGuideList" resultType="MainDTO">
	<![CDATA[
	SELECT *
	FROM (
	    SELECT ROWNUM AS rnum, subquery.*
	    FROM (
	        SELECT NOTICE_POST_NUMBER,
	               NOTICE_POST_TITLE,
	               TO_CHAR(NOTICE_POST_DATE, 'YYYY-MM-DD') AS NOTICE_POST_DATE
	        FROM TBL_NOTICE_POST 
	        WHERE NOTICE_TYPE_ID = 3
	        ORDER BY NOTICE_POST_DATE DESC
	    ) subquery
	)
	WHERE rnum <= 5
	]]>	
	</select>
	
</mapper>