<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="myPage">

	
	<!-- 포인트 충전 내역 조회 -->
	<select id="selectPoint" resultType="pointChargeRecordDTO">
	<![CDATA[
	SELECT *
	FROM (
	    SELECT ROWNUM AS rnum, subquery.*
	    FROM (
	        SELECT P.CHARGE_POINT,
	               P.AFTER_CHARGE_POINT,
	               P.CHARGE_DATE
	        FROM TBL_POST P
	        WHERE P.MEMBER_NUMBER = #{memberNumber}
	        ORDER BY P.CHARGE_DATE DESC
	    ) subquery
	)
	WHERE rnum BETWEEN #{startRow} AND #{endRow}
	]]>
	
	</select>
	<!-- 포인트 충전 -->
	<update id="chargePoint" parameterType="MemberDTO">
		update tbl_member set
		member_point = #{memberPoint}
		where member_number = #{memberNumber}
	</update>
	
	<!-- 게시글 조회 -->
	<select id="selectPostList" resultType="PostDTO" parameterType = "int">
		<![CDATA[
		SELECT *
		FROM (
		    SELECT ROWNUM AS rnum, subquery.*
		    FROM (
		        SELECT P.POST_NUMBER,
		        	   P.MEMBER_NUMBER,
		        	   NVL(P.TEAM_NUMBER, 0) as teamNumber,
		        	   NVL(P.ADMIN_NUMBER,0) as adminNumber,
		               P.POST_TITLE,
		               P.POST_CONTENT,
		               P.POST_DATE,
		               P.POST_UPDATE,
		               NVL(P.POST_LINK, 'NONE') as postLink,
		               NVL(P.journalist, 'NONE') as journalist,
		               P.POST_TYPE
		        FROM TBL_POST P
		        WHERE (P.POST_TYPE = 1 OR P.POST_TYPE = 2) AND P.MEMBER_NUMBER = #{memberNumber}
		        ORDER BY P.POST_DATE DESC
		    ) subquery
		)
		WHERE rnum BETWEEN #{startRow} AND #{endRow}
		]]>
	</select>
	
	<!-- 게시글 전체 수 -->	
	<select id = "getTotalPost" resultType = "int" parameterType = "int">
		SELECT COUNT(P.POST_NUMBER)
	    FROM TBL_POST P
	    WHERE P.POST_TYPE IN (1, 2) AND P.MEMBER_NUMBER = #{memberNumber}
	</select>
	
	<!-- 게시글 삭제 -->
	<delete id="deletePost" parameterType="int">
		delete from tbl_post
		where post_number = #{postNumber}
	</delete>
	
	<!-- 댓글 조회 -->
	<select id="selectCommentList" resultType="CommentDTO" parameterType = "map" >
		<![CDATA[
		SELECT *
		FROM (
		    SELECT ROWNUM AS rnum, subquery.*
		    FROM (
		        SELECT C.COMMENT_NUMBER,
		        	   C.COMMENT_CONTENT,
		        	   C.COMMENT_DATE,
		        	   C.COMMENT_UPDATE,
		        	   M.MEMBER_ID,
		        	   C.POST_NUMBER,
		        	   C.MEMBER_NUMBER,
		        	   P.POST_TITLE,
		        	   (
		        	   	SELECT PM.MEMBER_ID
		        	   	FROM TBL_MEMBER PM
		        	   	JOIN TBL_POST PP ON PP.MEMBER_NUMBER = PM.MEMBER_NUMBER 
		        	   	WHERE P.POST_NUMBER = PP.POST_NUMBER
		        	   ) as postAuthor
		        FROM TBL_COMMENT C
		        JOIN TBL_MEMBER M ON C.MEMBER_NUMBER = M.MEMBER_NUMBER
		        JOIN TBL_POST P ON C.POST_NUMBER = P.POST_NUMBER
		        WHERE C.MEMBER_NUMBER = #{memberNumber}
		        ORDER BY C.COMMENT_DATE DESC
		    ) subquery
		)
		WHERE rnum BETWEEN #{startRow} AND #{endRow}
		]]>
	</select>
	
	<!-- 댓글 전체 수 -->
	<select id = "getTotalComment" resultType = "int" parameterType = "int">
		SELECT COUNT(C.COMMENT_NUMBER)
		FROM TBL_COMMENT C
		WHERE C.MEMBER_NUMBER = #{memberNumber}
	</select>
	
	<!-- 댓글 삭제 -->
	<delete id="deleteComment" parameterType="int">
		delete from tbl_comment 
		from tbl_comment 
		where comment_number = #{commentNumber}
	</delete>
	
	<!-- 구매 목록 조회 -->
	<!-- <select id="selectTradeList" resultType="MyPageTradeListDTO">
		select t.trade_number, s.sell_post_title, s.dealtype_id, m.member_id, t.status_number, s.price_point, t.payment_date, t.complete_date
		from tbl_sell_post s join tbl_trade_post t on s.sell_post_number = t.trade_number
		join tbl_member m on s.member_number = m.member_number
		where s.member_number = #{memberNumber}
	</select> -->
	<select id="selectTradeList" resultType="MyPageTradeListDTO">
	<![CDATA[
	SELECT ROWNUM AS rnum, subquery.*
	    FROM (
	        SELECT T.TRADE_NUMBER,
	               S.SELL_POST_TITLE,
	               S.DEALTYPE_ID,
	               M.MEMBER_ID,
	               T.STATUS_NUMBER,
	               S.PRICE_POINT,
	               T.PAYMENT_DATE,
	               T.COMPLETE_DATE
	        FROM TBL_SELL_POST S 
	        JOIN TBL_TRADE_POST T ON S.SELL_POST_NUMBER = T.TRADE_NUMBER
	        JOIN TBL_MEMBER M ON S.MEMBER_NUMBER = M.MEMBER_NUMBER
	        WHERE P.BOARD_ID IN (1, 2) AND S.MEMBER_NUMBER = #{memberNumber}
	        ORDER BY T.PAYMENT_DATE DESC
	    ) subquery
	)
	WHERE rnum BETWEEN #{startRow} AND #{endRow}
	]]>
	</select>
	
	<!-- 구매 확정 -->
	<update id="completeTrade" parameterType="int">
		update tbl_trade_post 
		set status_number = 3
		where trade_number = #{tradeNumber}
	</update>
	
	<!-- 구매 취소 -->
	<update id="cancelTradeUpdate" parameterType="int">
		update tbl_sell_post
		set status_id = 1
		where sell_post_number = #{sellPostNumber}
	</update>
	<delete id="cancelTradeDelete" parameterType="int">
		delete from tbl_trade_post 
		where trade_number = #{tradeNumber}
	</delete>
	
	<!-- 판매 목록 조회 -->
	<!-- <select id="selectSellList" parameterType="int" resultType="MyPageTradeListDTO">
		select sell_post_number, member_number, status_id, dealtype_id, price_point, sell_post_title, 
		t.payment_date, t.complete_date
		from tbl_sell_post s join tbl_trade_post t on s.sell_post_number = t.trade_number
		where sell_post_number = #{sellPostNumber}
	</select> -->
	<select id="selectSe;;List" resultType="MyPageTradeListDTO">
	<![CDATA[
	SELECT ROWNUM AS rnum, subquery.*
	    FROM (
	        SELECT 
	               S.SELL_POST_NUMBER,
	               S.MEMBER_NUMBER,
	               T.SATTUS_ID,
	               S.DEALTYPE_ID,
	               S.PRICE_POINT,
	               S.SELL_POST_TITLE,
	               T.PAYMENT_DATE,
	               T.COMPLETE_DATE
	        FROM TBL_SELL_POST S 
	        JOIN TBL_TRADE_POST T ON S.SELL_POST_NUMBER = T.TRADE_NUMBER
	        WHERE SELL_POST_NUMBER = #{sellPostNumber}
	    ) subquery
	)
	WHERE rnum BETWEEN #{startRow} AND #{endRow}
	]]>
	</select>
	
	<!-- 판매글 삭제 -->
	<delete id="deleteSell" parameterType="int">
		delete from tbl_sell_post
		where sell_post_number = #{sellPostNumber}
	</delete>
	
	<!-- 회원 정보 수정 -->
	<update id="updateMember" parameterType="MemberDTO">
		update tbl_member
		set m.member_pw = #{memberPw}, m.member_phone = #{memberPhone}, m.member_emain = #{memberEmail},
		m.member_postal_code = #{memberPostalCode}, a.detailed_address = #{detailedAddress},
		m.my_team = #{myTeam}
		from tbl_member m join tbl_address a on m.member_postal_code = a.postal_code
		where member_number = #{memberNumber}
	</update>
	
	<!-- 회원 탈퇴 -->
	<delete id="quit" parameterType="int">
		delete from tbl_member
		where member_number = #{memberNumber}
	</delete>
	
</mapper>