<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="payment">

    <!-- 구매자 포인트 차감 -->
    <update id="decreaseBuyerPoint">
        UPDATE TBL_MEMBER
        SET MEMBER_POINT = MEMBER_POINT - #{price}
        WHERE MEMBER_NUMBER = #{buyerNumber}
          AND MEMBER_POINT >= #{price}
    </update>

    <!-- 판매자 포인트 적립 -->
    <update id="increaseSellerPoint">
        UPDATE TBL_MEMBER
        SET MEMBER_POINT = MEMBER_POINT + #{price}
        WHERE MEMBER_NUMBER = #{sellerNumber}
    </update>

    <!-- 거래 기록 생성 -->
    <insert id="insertTradePost">
        INSERT INTO TBL_TRADE_POST(
            TRADE_NUMBER, SELL_POST_NUMBER, STATUS_NUMBER, BUY_MEMBER, PAYMENT_DATE
        ) VALUES (
            seq_TRADE_POST.nextval, #{sellPostNumber}, 3, #{buyerNumber}, SYSDATE
        )
    </insert>

    <!-- 판매글 상태 변경 -->
    <update id="updateSellPostStatus">
        UPDATE TBL_SELL_POST
        SET STATUS_ID = 2
        WHERE SELL_POST_NUMBER = #{sellPostNumber}
    </update>
    
    <!-- 판매글 상태 판매중으로 되돌리기 -->
	<update id="updateSellPostStatusAfterCancel" parameterType="map">
	    UPDATE TBL_SELL_POST s
	    SET s.STATUS_ID = 1  <!-- 1 = 'selling' -->
	    WHERE s.SELL_POST_NUMBER = (
	        SELECT t.SELL_POST_NUMBER
	        FROM TBL_TRADE_POST t
	        WHERE t.TRADE_NUMBER = #{tradeNumber}
	    )
	</update>
	
	<!-- 구매자 포인트 환불 -->
	<update id="refundBuyerPoint" parameterType="map">
	    UPDATE TBL_MEMBER m
	    SET m.MEMBER_POINT = m.MEMBER_POINT + (
	        SELECT t.PRICE_POINT
	        FROM TBL_TRADE_POST t
	        WHERE t.TRADE_NUMBER = #{tradeNumber}
	    )
	    WHERE m.MEMBER_NUMBER = (
	        SELECT t.BUY_MEMBER
	        FROM TBL_TRADE_POST t
	        WHERE t.TRADE_NUMBER = #{tradeNumber}
	    )
	</update>
	
	<!-- 포인트 충전 -->
	<update id="chargeMemberPoint" parameterType="map">
	    UPDATE TBL_MEMBER
	    SET MEMBER_POINT = MEMBER_POINT + #{chargePoint}
	    WHERE MEMBER_NUMBER = #{memberNumber}
	</update>
	
</mapper>
