<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="teamMain">

	<!-- <![CDATA[
	SELECT *
	FROM (
	    SELECT ROWNUM AS rnum, subquery.*
	    FROM (
	        SELECT P.POST_NUMBER,
	               P.POST_TITLE,
	               P.POST_CONTENT,
	               P.POST_DATE,
	               M.MEMBER_ID
	        FROM TBL_POST P
	        JOIN TBL_MEMBER M ON P.MEMBER_NUMBER = M.MEMBER_NUMBER
	        WHERE P.BOARD_ID = 2
	          AND P.TEAM_NUMBER = {teamNumber}
	        ORDER BY P.POST_DATE DESC
	    ) subquery
	)
	WHERE rnum BETWEEN #{startRow} AND #{endRow}
	]]> -->
	
	<!-- 팀 뉴스 목록 조회(5개) -->
	<select id="selectNewsList" resultType="TeamMainDTO">
	<![CDATA[
	SELECT *
	FROM (
	    SELECT ROWNUM AS rnum, subquery.*
	    FROM (
	        SELECT P.POST_TITLE as news_post_title,
	        		P.POST_NUMBER as news_post_number
	        FROM TBL_POST P
	        WHERE POST_TYPE = 3
	          AND TEAM_NUMBER = #{teamNumber}
	        ORDER BY POST_DATE DESC
	    ) subquery
	)
	WHERE rnum <= 5
	]]>
	</select>

	<!-- 팀 게시글 목록 조회(10개) -->
	<select id="selectPostList" resultType="TeamMainDTO">
	<![CDATA[
	SELECT *
	FROM (
	    SELECT ROWNUM AS rnum, subquery.*
	    FROM (
	        SELECT P.POST_NUMBER,
	               P.POST_TITLE,
	               M.MEMBER_ID,
	               TO_CHAR(P.POST_DATE, 'YYYY-MM-DD') AS POST_DATE
	        FROM TBL_POST P 
	        JOIN TBL_MEMBER M ON P.MEMBER_NUMBER = M.MEMBER_NUMBER
	        WHERE P.POST_TYPE = 2
	          AND P.TEAM_NUMBER = #{teamNumber}
	        ORDER BY P.POST_DATE DESC
	    ) subquery
	)
	WHERE rnum <= 10
	]]>
	</select>

	<!-- 팀 유튜브 썸네일 목록 조회(3개) -->
	<select id="selectYouTubeList" resultType="TeamMainDTO">
	<![CDATA[
	SELECT *
	FROM (
	    SELECT ROWNUM AS rnum, subquery.*
	    FROM (
	        SELECT A.ATTACHMENT_PATH,
	        	   P.POST_LINK
	        FROM TBL_POST P
	        LEFT OUTER JOIN TBL_ATTACHMENT A ON P.POST_NUMBER = A.POST_NUMBER
	        WHERE P.POST_TYPE = 4
	          AND P.TEAM_NUMBER = #{teamNumber}
	        ORDER BY P.POST_DATE DESC
	    ) subquery
	)
	WHERE rnum <= 3
	]]>
	</select>

	<!-- 팀별 경기 일정 목록 조회 -->
	<select id="selectTeamSchedule" parameterType="int" resultType="TeamMainDTO">
	<![CDATA[
		select t1.team_name as away_team_name , st.stadium_name, t2.team_name as home_team_name, 
		to_char(sc.schedule_date, 'FMMM.FMDD(DY) HH:mi') as schedule_date
		from tbl_game_schedule sc join tbl_stadium st on sc.home_team_number = st.team_number
		join tbl_team t1 on sc.home_team_number = t1.team_number
		join tbl_team t2 on sc.away_team_number = t2.team_number
		where (sc.home_team_number = #{teamNumber} or sc.away_team_number = #{teamNumber})
		and (sc.schedule_date between trunc(sysdate, 'iw') and trunc(sysdate, 'iw') + 7)
		order by sc.schedule_date
	]]>
	</select>
	
	<!-- 팀 순위 목록 조회 -->
	<select id="selectTeamRank" resultType="TeamMainDTO">
	<![CDATA[
		select r.team_rank, t.team_name, r.game_count, r.team_win, r.team_draw, r.team_lose, r.team_win_rate, r.team_gb
		from tbl_team_ranking r join tbl_team t on r.team_number = t.team_number
		order by r.team_rank
	]]>
	</select>

	<!-- 팀 커뮤니티 게시글 검색 목록 조회 -->
	<select id="searchPost" parameterType="map" resultType="TeamPostDTO">
	<![CDATA[
	SELECT *
	FROM (
	    SELECT ROWNUM AS RNUM, SUBQUERY.*
	    FROM (
	        SELECT POST_TYPE, POST_NUMBER, POST_TITLE, M.MEMBER_ID, TO_CHAR(POST_DATE, 'YYYY-MM-DD') AS POST_DATE
			FROM TBL_POST P LEFT OUTER JOIN TBL_MEMBER M 
			ON P.MEMBER_NUMBER = M.MEMBER_NUMBER
			WHERE (POST_TITLE LIKE '%#{keyword}%' OR MEMBER_ID LIKE '%#{keyword}%')
			AND TEAM_NUMBER = #{teamNumber}
			AND POST_TYPE != 1
			ORDER BY POST_DATE DESC
	    ) SUBQUERY
	)
	WHERE RNUM BETWEEN #{postStartRow} AND #{postEndRow};
	]]>
	</select>
	
	<!-- 팀 커뮤니티 공지사항 검색 목록 조회 -->
	<select id="searchNotice" parameterType="map" resultType="NoticePostDTO">
	<![CDATA[
	SELECT *
	FROM (
	    SELECT ROWNUM AS RNUM, SUBQUERY.*
	    FROM (
	       SELECT NOTICE_POST_TITLE, NOTICE_POST_DATE
			FROM TBL_NOTICE_POST
			WHERE NOTICE_POST_TITLE LIKE '%#{keyword}%'
			AND TEAM_NUMBER = #{teamNumber}
			AND NOTICE_TYPE_ID = 2
			ORDER BY NOTICE_POST_DATE DESC
	    ) SUBQUERY
	)
	WHERE RNUM BETWEEN #{noticeStartRow} AND #{noticeEndRow};
	]]>
	</select>
	
	<!-- 팀 게시글 검색 결과 전체 개수 조회 -->
	<select id="totalSearchPost" parameterType="map" resultType="int">
	<![CDATA[
		select count(*)
		from tbl_post p join tbl_member m 
		on p.member_number = m.member_number
		where (post_title like '%#{keyword}%' or member_id like '%#{keyword}%')
		and team_number = #{teamNumber}
		and post_type != 1
	]]>
	</select>
	
	<!-- 팀 공지사항 검색 결과 전체 개수 조회 -->
	<select id="totalSearchNotice" parameterType="map" resultType="int">
	<![CDATA[
		select count(*) 
		from tbl_notice_post
		where notice_post_title like '%#{keyword}%'
		and team_number = #{teamNumber}
		and notice_type_id = 2
	]]>
	</select>
</mapper>