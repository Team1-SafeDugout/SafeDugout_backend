<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="teamCommunity">

	<!-- 팀 게시글 목록 조회 -->
	<select id="selectTeamBoard" parameterType="map" resultType="TeamPostDTO">
	    <![CDATA[
	    SELECT * FROM (
	        SELECT ROWNUM AS rnum, subquery.*
	        FROM (
	            SELECT 
	                P.POST_NUMBER, 
	                P.POST_TITLE, 
	                M.MEMBER_ID,
	                P.POST_DATE
	            FROM TBL_POST P
	            JOIN TBL_MEMBER M ON P.MEMBER_NUMBER = M.MEMBER_NUMBER
	            WHERE P.POST_TYPE = 2
	              AND P.TEAM_NUMBER = #{teamNumber}
	            ORDER BY P.POST_DATE DESC
	        ) subquery
	    )
	    WHERE rnum BETWEEN #{startRow} AND #{endRow}
	    ]]>
	</select>

	<!-- 게시글 작성 -->
	<insert id="insert" parameterType="TeamPostDTO">
		<selectKey keyProperty="postNumber" resultType="int" order="BEFORE">
			SELECT SEQ_POST.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO TBL_POST (POST_NUMBER, MEMBER_NUMBER, TEAM_NUMBER, POST_TITLE, POST_CONTENT, POST_DATE, POST_TYPE)
    	 VALUES (#{postNumber}, #{memberNumber}, #{teamNumber}, #{postTitle}, #{postContent}, SYSDATE, #{postType})
	</insert>

	<!-- 팀 게시글 상세 조회 -->
	<select id="detailSelect" parameterType="PostDetailDTO" resultType="PostDetailDTO">
	  <![CDATA[
	  SELECT 
	      P.POST_NUMBER,
	      P.POST_TITLE,
	      P.POST_CONTENT,
	      P.POST_DATE,
	      M.MEMBER_ID,
	      M.MEMBER_NUMBER,
	      C.COMMENT_NUMBER,
	      C.COMMENT_CONTENT,
	      NVL(C.COMMENT_UPDATE, C.COMMENT_DATE) AS COMMENT_LAST_UPDATE,
	      CM.MEMBER_ID AS COMMENT_WRITER,
	      A.ATTACHMENT_NUMBER,
	      A.ATTACHMENT_NAME,
	      A.ATTACHMENT_PATH
	  FROM TBL_POST P
	  JOIN TBL_MEMBER M
	      ON P.MEMBER_NUMBER = M.MEMBER_NUMBER
	  LEFT JOIN TBL_COMMENT C
	      ON P.POST_NUMBER = C.POST_NUMBER
	  LEFT JOIN TBL_MEMBER CM
	      ON C.MEMBER_NUMBER = CM.MEMBER_NUMBER
	  LEFT JOIN TBL_ATTACHMENT A
	      ON P.POST_NUMBER = A.POST_NUMBER
	  WHERE P.POST_NUMBER = #{postNumber}
	    AND P.TEAM_NUMBER = #{teamNumber}
	  ORDER BY 
	      C.COMMENT_DATE ASC,
	      A.ATTACHMENT_NUMBER ASC
	  ]]>
	</select>

	<!-- 팀 뉴스글 상세 조회 -->
	<select id="detailNewsSelect" parameterType="map" resultType="NewsDetailDTO">
	    SELECT P.POST_NUMBER,
	           P.POST_TITLE,
	           P.POST_CONTENT,
	           P.POST_DATE,
	           P.JOURNALIST,
	           P.POST_LINK,
	           A.ATTACHMENT_NUMBER,
	           A.ATTACHMENT_NAME,
	           A.ATTACHMENT_PATH
	    FROM TBL_POST P
	    LEFT JOIN TBL_ATTACHMENT A ON P.POST_NUMBER = A.POST_NUMBER
	    WHERE P.POST_NUMBER = #{postNumber}
	    ORDER BY A.ATTACHMENT_NUMBER ASC
	</select>
	
	<!-- 게시글 삭제 -->
	<delete id="delete" parameterType="int">
		delete from tbl_post
		where
		post_number = #{postNumber}
	</delete>



	<!-- 게시글 수정 -->
	<update id="updatePost" parameterType="TeamPostDTO">
		UPDATE TBL_POST
		SET POST_TITLE = #{postTitle},
		POST_CONTENT = #{postContent},
		POST_UPDATE = SYSDATE
		WHERE POST_NUMBER = #{postNumber}
	</update>


	<!-- 팀 유튜브 목록 조회 -->
	<select id="youtubeSelect" parameterType="map" resultType="YoutubePostDTO">
		<![CDATA[
		SELECT * FROM (
        SELECT ROWNUM AS rnum, subquery.*
        FROM (
            SELECT p.POST_NUMBER,
                   p.POST_TITLE,
                   p.POST_DATE,
                   p.POST_CONTENT,
                   p.POST_LINK,
                   t.TEAM_NAME,
                   t.TEAM_NUMBER,
                   a.ADMIN_id
            FROM TBL_POST p
            JOIN TBL_TEAM t ON p.TEAM_NUMBER = t.TEAM_NUMBER
            JOIN TBL_ADMIN a ON p.ADMIN_NUMBER = a.ADMIN_NUMBER
            WHERE p.POST_TYPE = 4
            AND p.TEAM_NUMBER = #{teamNumber}
            ORDER BY p.POST_DATE DESC
        ) subquery
    )WHERE rnum BETWEEN #{startRow} AND #{endRow}
		]]>
	</select>



	<!-- 팀/선수 응원가 목록 조회 -->
	<select id="songSelect" parameterType="map" resultType="SongPostDTO">
		<![CDATA[
		SELECT * FROM (
	        SELECT ROWNUM AS rnum, subquery.*
	        FROM (
	            SELECT POST_NUMBER,
	                   POST_TITLE,
	                   POST_DATE,
	                   TEAM_NUMBER,
	                   BOARD_ID,
	                   POST_LINK,
	                   POST_CONTENT
	            FROM TBL_POST
	            WHERE POST_TYPE IN (5, 6)
	              AND TEAM_NUMBER = #{teamNumber}
	            ORDER BY POST_DATE DESC
	        )subquery
	    )
	    WHERE rnum BETWEEN #{startRow} AND #{endRow}
		]]>
	</select>
	
	<!-- 팀응원가 목록 조회 -->
	<select id="TeamSongSelect" parameterType="map" resultType="SongPostDTO">
		<![CDATA[
			SELECT * FROM (
		    SELECT ROWNUM AS rnum, subquery.*
		    FROM (
		        SELECT p.POST_NUMBER,
		               p.POST_TITLE,
		               p.POST_DATE,
		               p.TEAM_NUMBER,
		               t.TEAM_NAME,
		               p.BOARD_ID,
		               p.POST_LINK,
		               p.POST_CONTENT
		        FROM TBL_POST p
		        JOIN TBL_TEAM t
		          ON p.TEAM_NUMBER = t.TEAM_NUMBER
		        WHERE p.POST_TYPE = 5
		          AND p.TEAM_NUMBER = #{teamNumber}
		        ORDER BY p.POST_DATE DESC
		    ) subquery
		)
		WHERE rnum BETWEEN #{startRow} AND #{endRow}
		]]>
	</select>
	
	<!-- 선수 응원가 목록 조회 -->
	<select id="playerSongSelect"  parameterType="map"  resultType="SongPostDTO">
		<![CDATA[
		SELECT * FROM (
		    SELECT ROWNUM AS rnum, subquery.*
		    FROM (
		        SELECT p.POST_NUMBER,
		               p.POST_TITLE,
		               p.POST_DATE,
		               p.TEAM_NUMBER,
		               t.TEAM_NAME,
		               p.POST_LINK,
		               p.POST_CONTENT
		        FROM TBL_POST p
		        JOIN TBL_TEAM t
		          ON p.TEAM_NUMBER = t.TEAM_NUMBER
		        WHERE p.POST_TYPE = 6
		          AND p.TEAM_NUMBER = #{teamNumber}
		        ORDER BY p.POST_DATE DESC
		    ) subquery
		)
		WHERE rnum BETWEEN #{startRow} AND #{endRow}
		]]>
	</select>
		
	<!-- 뉴스 목록 조회 -->	
	<select id="newsSelect" parameterType="map" resultType="NewsPostDTO">
	<![CDATA[
	SELECT *
	FROM (
	    SELECT subquery.*, ROWNUM AS rnum
	    FROM (
	        SELECT 
	               P.POST_NUMBER,
	               P.POST_TITLE,
	               P.POST_CONTENT,
	               P.POST_DATE,
	               P.TEAM_NUMBER,
	               T.TEAM_NAME AS TEAM_NAME,
	               (SELECT A.ATTACHMENT_PATH 
	                FROM TBL_ATTACHMENT A
	                WHERE A.POST_NUMBER = P.POST_NUMBER
	                AND ROWNUM = 1) AS IMG_PATH,
	               P.JOURNALIST
	        FROM TBL_POST P
	        LEFT JOIN TBL_TEAM T ON P.TEAM_NUMBER = T.TEAM_NUMBER
	        WHERE P.POST_TYPE = 3
	          AND P.TEAM_NUMBER = #{teamNumber}
	        ORDER BY P.POST_DATE DESC
	    ) subquery
	)
	WHERE rnum BETWEEN #{startRow} AND #{endRow}
	]]>
	</select>



	<!-- 팀 시즌 기록 목록 조회 -->
	<select id="teamRecordSelect" parameterType="map" resultType="TeamRecordDTO">
		<![CDATA[
		SELECT TR.SEASON_YEAR, T.TEAM_NAME,	TR.TEAM_RANK, TR.GAME_COUNT, TR.TEAM_WIN, TR.TEAM_DRAW, TR.TEAM_LOSE, TR.TEAM_WIN_RATE, TR.TEAM_AVG_BAT, TR.TEAM_ERA,
       	TR.TEAM_SCORE, TR.TEAM_CONCEDE
		FROM TBL_TEAM_RECORD TR
		JOIN TBL_TEAM T ON TR.TEAM_NUMBER = T.TEAM_NUMBER
		WHERE TR.TEAM_NUMBER = #{teamNumber}
		ORDER BY TR.SEASON_YEAR DESC
		]]>
	</select>

	<!-- 팀 투수 시즌 기록 조회 -->
  <select id="pitcherRecordSelect" parameterType="map" resultType="TeamPitcherRecordDTO">
        <![CDATA[
        SELECT 
           TPR.TEAM_NUMBER,
           TPR.SEASON_YEAR,
           T.TEAM_NAME, 
           TPR.TEAM_PITCHER_ERA, 
           TPR.TEAM_PITCHER_GAME_COUNT, 
           TPR.TEAM_PITCHER_WIN,
           TPR.TEAM_PITCHER_LOSE, 
           TPR.TEAM_PITCHER_SAVE, 
           TPR.TEAM_PITCHER_HOLD, 
           TPR.TEAM_PITCHER_WPCT,
           TPR.TEAM_PITCHER_IP,
           TPR.TEAM_PITCHER_HITS,
           TPR.TEAM_PITCHER_HR, 
           TPR.TEAM_PITCHER_BB, 
           TPR.TEAM_PITCHER_HBP, 
           TPR.TEAM_PITCHER_STRIKEOUT, 
           TPR.TEAM_PITCHER_SCORE,
           TPR.TEAM_PITCHER_ER, 
           TPR.TEAM_PITCHER_WHIP
        FROM TBL_TEAM_PITCHER_RECORD TPR
        JOIN TBL_TEAM T ON TPR.TEAM_NUMBER = T.TEAM_NUMBER
        WHERE TPR.TEAM_NUMBER = #{teamNumber}
        ORDER BY TPR.SEASON_YEAR DESC
        ]]>
    </select>

	<!-- 팀 타자 시즌 기록 조회 -->
	<select id="batterRecordSelect" parameterType="map" resultType="TeamBatterRecordDTO">
	<![CDATA[
	SELECT TBR.SEASON_YEAR,
	    T.TEAM_NAME, TBR.TEAM_BATTER_AVG_BAT, TBR.TEAM_BATTER_GAME_COUNT,
	    TBR.TEAM_BATTER_RBI, TBR.TEAM_BATTER_HITS, TBR.TEAM_BATTER_DOUBLE_HIT,
	    TBR.TEAM_BATTER_TRIPLE_HIT, TBR.TEAM_BATTER_HR,
	    TBR.TEAM_BATTER_PA_BAT, TBR.TEAM_BATTER_AB, TBR.TEAM_BATTER_R, TBR.TEAM_BATTER_TB,
	    TBR.TEAM_BATTER_SAC, TBR.TEAM_BATTER_SF
	FROM TBL_TEAM_BATTER_RECORD TBR
	JOIN TBL_TEAM T ON TBR.TEAM_ID = T.TEAM_NUMBER
	WHERE TBR.TEAM_ID = #{teamNumber}
	ORDER BY TBR.SEASON_YEAR DESC
	]]>
	</select>
	
	<!-- 팀 수비/주루기록 -->
	<select id="deffenseBaseRecord" parameterType="map" resultType="DeffenseBaseRecordDTO">
	SELECT 
	    T.TEAM_NAME,
	    R.SEASON_YEAR,
	    R.GAME_COUNT,
	    R.ERROR,
	    R.DP,
	    R.SB,
	    R.CB,
	    R.SB_SUCCESS,
	    R.PICK_OFF,
	    R.PICK_OFF_SUCCESS
	FROM TBL_DEFENSE_BASE_RECORD R
	JOIN TBL_TEAM T ON R.TEAM_NUMBER = T.TEAM_NUMBER
	WHERE R.TEAM_NUMBER = #{teamNumber}
	AND R.SEASON_YEAR = #{seasonYear}
	ORDER BY R.SEASON_YEAR DESC
	</select>
	
	<!-- 선수 타자 기록 -->
	<select id="playerBatterRecord" parameterType="map" resultType="BatterRecordDTO">
	SELECT 
	    T.TEAM_NAME,
	    P.PLAYER_NAME,
	    P.PLAYER_POSITION,
	    P.TEAM_NUMBER,
	    TO_CHAR(B.BATTER_SEASON_YEAR, 'YYYY') AS SEASON_YEAR,
	    B.BATTER_GAMES,
	    B.AB,
	    B.PA,
	    B.RBI,
	    B.HITS,
	    B.DOUBLE_HIT,
	    B.TRIPLE_HIT,
	    B.HOME_RUN,
	    B.BATTER_BB,
	    B.IBB,
	    B.BATTER_HBP,
	    B.SO,
	    B.GDP,
	    B.SRBI,
	    B.OPS,
	    B.SB
	FROM TBL_BATTER_RECORD B
	JOIN TBL_PLAYER P ON B.PLAYER_NUMBER = P.PLAYER_NUMBER
	JOIN TBL_TEAM T ON P.TEAM_NUMBER = T.TEAM_NUMBER
	WHERE P.TEAM_NUMBER = #{teamNumber}
	ORDER BY B.BATTER_SEASON_YEAR DESC, P.PLAYER_NUMBER
	</select>
	
	<!-- 투수 기록 -->
	<select id="playerPitcherRecord" parameterType="map" resultType="PitcherRecordDTO">
	SELECT 
	    T.TEAM_NAME,
	    P.PLAYER_NAME,
	    P.PLAYER_POSITION,
	    P.TEAM_NUMBER,
	    TO_CHAR(R.PITCHER_SEASON_YEAR, 'YYYY') AS SEASON_YEAR,
	    R.PITCHER_GAMES,
	    R.CG,
	    R.SHO,
	    R.GS,
	    R.WINS,
	    R.LOSSES,
	    R.SAVES,
	    R.HOLD,
	    R.IP,
	    R.RA,
	    R.ER,
	    R.ERA,
	    R.HIT_ALLOWED,
	    R.HR_ALLOWED,
	    R.PITCHER_BB,
	    R.PITCHER_HBP,
	    R.BK
	FROM TBL_PITCHER_RECORD R
	JOIN TBL_PLAYER P ON R.PLAYER_NUMBER = P.PLAYER_NUMBER
	JOIN TBL_TEAM T ON P.TEAM_NUMBER = T.TEAM_NUMBER
	WHERE P.TEAM_NUMBER = #{teamNumber}
	ORDER BY R.PITCHER_SEASON_YEAR DESC, P.PLAYER_NUMBER
	</select>
	
	<!-- 게시글 총 갯수 -->
	<select id="getTotalBoard" parameterType="int" resultType="int">
	    SELECT COUNT(P.POST_NUMBER)
	    FROM TBL_POST P
	    WHERE P.POST_TYPE = 2
	      AND P.TEAM_NUMBER = #{teamNumber}
	</select>
	
	<!-- 뉴스 총 갯수  -->
	<select id="getTotalNews" resultType="int">
		SELECT COUNT(P.POST_NUMBER)
		FROM tbl_post p
		where p.POST_TYPE = 3
	      AND p.TEAM_NUMBER = #{teamNumber}
	</select>
	
	<!-- 유튜브 총 갯수 -->
	<select id="getTotalYoutube" resultType="int">
		SELECT COUNT(P.POST_NUMBER)
		FROM tbl_post p
		where p.POST_TYPE = 4
	      AND p.TEAM_NUMBER = #{teamNumber}
	</select>
		
	<!-- 팀응원가 총 갯수 -->
	<select id="getTotalSong" resultType="int">
		SELECT COUNT(P.POST_NUMBER)
		FROM tbl_post p
		where p.POST_TYPE IN(5, 6)
	      AND p.TEAM_NUMBER = #{teamNumber}		
	</select>	
	
	<!-- 팀응원가 총 갯수 -->
	<select id="getTotalTeamSong" resultType="int">
		SELECT COUNT(P.POST_NUMBER)
		FROM tbl_post p
		where p.POST_TYPE = 5
	      AND p.TEAM_NUMBER = #{teamNumber}		
	</select>	
	
	<!-- 선수 응원가 총 갯수 -->
	<select id="getTotalPlayerSong" resultType="int">
		SELECT COUNT(P.POST_NUMBER)
		FROM tbl_post p
		where p.POST_TYPE = 6
	      AND p.TEAM_NUMBER = #{teamNumber}
	</select>
	
	<!-- 경기장 정보 조회 -->
	<select id="selectStadium" parameterType="int" resultType="StadiumDTO">
	SELECT 
	    STADIUM_NUMBER,
	    STADIUM_NAME,
	    STADIUM_ADDRESS,
	    TEAM_NUMBER
	FROM TBL_STADIUM
	WHERE TEAM_NUMBER = #{teamNumber}
	</select>
	
	<!-- 경기장 티켓 조회 -->
	<select id="selectTicket" parameterType="int" resultType="StadiumTicketDTO">
		SELECT 
	    TICKET_ID,
	    STADIUM_NUMBER,
	    TEAM_NUMBER,
	    SEAT_NAME,
	    WEEKDAY_PRICE,
	    WEEKEND_PRICE,
	    RESERVATION_SITE
	FROM TBL_STADIUM_TICKET
	WHERE TEAM_NUMBER = #{stadiumNumber}
	</select>
	
	<!-- 경기장 먹거리 조회 -->
	<select id="selectFood" parameterType="int" resultType="StadiumFoodDTO">
	SELECT 
	    FOOD_ID,
	    FOOD_NAME,
	    FOOD_LOCATION,
	    FOOD_TIP,
	    STADIUM_NUMBER
	FROM TBL_STADIUM_FOOD
	WHERE STADIUM_NUMBER = #{stadiumNumber}
	</select>
	
	<!-- 게임 일정 조회 -->
	<select id="selectGame" parameterType="map" resultType="GameScheduleDTO">
	SELECT
	    gs.GAME_ID,
	    gs.SCHEDULE_DATE,
	    ht.TEAM_NAME AS HOME_TEAM,
	    at.TEAM_NAME AS AWAY_TEAM,
	    s.STADIUM_NAME,
	    s.STADIUM_ADDRESS
	FROM
	    TBL_GAME_SCHEDULE gs
	JOIN TBL_TEAM ht
	    ON gs.HOME_TEAM_NUMBER = ht.TEAM_NUMBER
	JOIN TBL_TEAM at
	    ON gs.AWAY_TEAM_NUMBER = at.TEAM_NUMBER
	JOIN TBL_STADIUM s
	    ON gs.STADIUM_NUMBER = s.STADIUM_NUMBER
	WHERE
	    gs.HOME_TEAM_NUMBER = #{teamNumber} OR gs.AWAY_TEAM_NUMBER = #{teamNumber}
	ORDER BY
	    gs.SCHEDULE_DATE
	</select>
	
	<!-- 게시글 작성자 번호 조회 -->
	<select id="getWriterNumber" parameterType="int" resultType="int">
	    SELECT MEMBER_NUMBER
	    FROM TBL_POST
	    WHERE POST_NUMBER = #{postNumber}
	</select>
</mapper>